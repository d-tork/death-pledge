var Dpy;var ImageViewerLightbox;var ImageViewerML={th:null,closeth:null,play:null,pause:null,print:null};var ImageViewerClass=function(viewer,nMax,strMediaURL,straCaptions,oStdParams,oImageInfo,nInitial){var $m_viewer=$(viewer);var m_bThumbsOpen=false;var m_bCaptionOpen=false;var m_straCaptions=straCaptions||[];var $m_caption=$('.bar .caption',$m_viewer);var m_nCurrent=0;var m_nMaxLoaded=0;var $m_images=$('.stage .images',$m_viewer);var $m_imgFirst=$('img',$m_images).clone().attr('src','/matrix/images/c.gif');var m_nWidth=oImageInfo.m.w;var m_nHeight=oImageInfo.m.h;var $m_count=$('.bar .count',$m_viewer);var $m_slide=$('.bar .slideshow',$m_viewer);var m_oSlideshowTimer;var $m_navRight=$('.nav.right',$m_viewer);var $m_navLeft=$('.nav.left',$m_viewer);var DEBUG=false;var viewPortWidth=function(){return Math.max(document.documentElement.clientWidth,window.innerWidth||0)};var viewPortHeight=function(){return Math.max(document.documentElement.clientHeight,window.innerHeight||0)};var setCount=function(){$m_count.text(m_nCurrent+1+' / '+nMax);if(DEBUG)console.log('setCount called')};setCount();$m_viewer.toggleClass('touch',ImageViewerClass.isTouch);$('.bar .print',$m_viewer).click(function(ev){if(oStdParams)Dpy.photoPopup($.extend({n:nMax,i:m_nCurrent},oStdParams))});$m_caption.click(function(ev){if(!$m_caption.hasClass("pointer"))return;if(m_bCaptionOpen)closeCaptionContainer();else openCaptionContainer()});var openCaptionContainer=function(){m_bCaptionOpen=true;var nCaptionHeight=$m_caption.height()-$m_count.height()+1;$m_caption.addClass("open");$m_caption.stop(true).animate({top:-nCaptionHeight})};var closeCaptionContainer=function(){m_bCaptionOpen=false;$m_caption.stop(true).animate({top:0},{duration:400,complete:function(){$m_caption.removeClass("open")}})};var showCaption=function(index){if(!m_straCaptions.length)m_straCaptions=$m_viewer.data('captions')||[];$m_caption.text(m_straCaptions[index]);$m_caption.attr('title',m_straCaptions[index]);$m_caption.removeClass("pointer");$m_caption.removeClass("nopointer");closeCaptionContainer();$m_caption.css("max-height",$m_viewer.height()-10);if($m_caption.height()>$m_count.height()){$m_caption.addClass("pointer");if($m_caption.height()<=$m_count.height())$m_caption.removeClass("pointer").addClass("nopointer");else $('<span/>',{text:'...'}).appendTo($m_caption).addClass('moreIndicator')}else $m_caption.removeClass("pointer");if(DEBUG)console.log('showCaption called')};$m_viewer.on('captionsloaded',function(ev){showCaption(m_nCurrent)});if(m_straCaptions.length&&m_nWidth>300)showCaption(m_nCurrent);var ensureLoaded=function(index){if(DEBUG)console.log('ensureLoaded start');while(index>m_nMaxLoaded)(function(){var $img=$m_imgFirst.clone();$img.css('width',m_nWidth);$img.css('height',m_nHeight);$m_images.append($img.attr('src',strMediaURL+oImageInfo.m.u+ ++m_nMaxLoaded));setTimeout(function(){$img.addClass('loading')},750)})();if(DEBUG)console.log('ensureLoaded end')};var toggleNextAndPrevOn=function(enabled){$('.nav.right').attr("disabled",!enabled);$('.nav.left').attr("disabled",!enabled)};var previous=function(ev){toggleNextAndPrevOn(false);if(DEBUG)console.log('previous start');ev.preventDefault();ev.stopPropagation();var fOnAnimationComplete,$tmpImg;if(m_bThumbsOpen)toggleNextAndPrevOn(true);else{if(m_nCurrent===0){m_nCurrent=nMax-1;$tmpImg=$m_imgFirst.clone().attr('src',strMediaURL+oImageInfo.m.u+m_nCurrent);var aid=adjustedImageDimensions();$tmpImg.css({width:aid.width,height:aid.height});$m_images.prepend($tmpImg);$m_images.css({left:adjustedImageDimensions().width*-1});fOnAnimationComplete=function(){ensureLoaded(m_nCurrent);setTimeout(function(){$tmpImg.remove();var aid=adjustedImageDimensions();$m_images.css({left:-1*parseInt(aid.width)*m_nCurrent});$m_images.find('img').css({width:aid.width,height:aid.height});showCaption(m_nCurrent);if(DEBUG)console.log('prev set timeout called');toggleNextAndPrevOn(true)},150)}}else{m_nCurrent-=1;$m_images.find('img').css({width:m_nWidth,height:m_nHeight});fOnAnimationComplete=function(){showCaption(m_nCurrent);toggleNextAndPrevOn(true)}}$m_images.stop(true,true).animate({left:'+='+m_nWidth},250,fOnAnimationComplete);setCount()}if(DEBUG)console.log('previous end')};var next=function(ev){toggleNextAndPrevOn(false);if(DEBUG)console.log('next start');if(ev){ev.preventDefault();ev.stopPropagation()}var fOnAnimationComplete,$tmpImg;if(m_bThumbsOpen)toggleNextAndPrevOn(true);else{if(m_nCurrent===nMax-1){m_nCurrent=0;var aid=adjustedImageDimensions();$tmpImg=$m_imgFirst.clone().attr('src',strMediaURL+oImageInfo.m.u+m_nCurrent).css({width:aid.width,height:aid.height});$m_images.append($tmpImg);fOnAnimationComplete=function(){$tmpImg.remove();$m_images.css({left:0});showCaption(m_nCurrent);toggleNextAndPrevOn(true)}}else{m_nCurrent+=1;ensureLoaded(m_nCurrent);$m_images.find('img').css({width:m_nWidth,height:m_nHeight});fOnAnimationComplete=function(){showCaption(m_nCurrent);toggleNextAndPrevOn(true)}}$m_images.stop(true,true).animate({left:'-='+m_nWidth},250,fOnAnimationComplete);setCount()}if(DEBUG)console.log('next end')};var jump=function(nIndex){ensureLoaded(nIndex);$m_images.css({left:-nIndex*m_nWidth});m_nCurrent=nIndex;setCount();showCaption(m_nCurrent)};var stopSlideShow=function(){window.clearInterval(m_oSlideshowTimer);m_oSlideshowTimer=null;$m_slide.removeClass('pause').addClass('slideshow').attr('title',ImageViewerML.play);ImageViewerClass.stopSlideShow=null};var startSlideShow=function(){next();m_oSlideshowTimer=setInterval(next,5000);$m_slide.removeClass('slideshow').addClass('pause').attr('title',ImageViewerML.pause);ImageViewerClass.stopSlideShow=function(){stopSlideShow()}};if(nMax>1)$m_slide.click(function(ev){if(m_oSlideshowTimer)stopSlideShow();else{if(ImageViewerClass.stopSlideShow)ImageViewerClass.stopSlideShow();startSlideShow()}});else $m_slide.hide();var $openLightbox=$('.bar .lb',$m_viewer);var fLB=oImageInfo.l?function(){ImageViewerLightbox(nMax,strMediaURL,m_straCaptions,oStdParams,oImageInfo,m_nCurrent)}:oImageInfo.openLB?oImageInfo.openLB:false;if(fLB){$openLightbox.click(fLB);$m_images.click(fLB)}else $openLightbox.hide();var oNav=function(){var $navLeft=$('.nav.left',$m_viewer).click(previous).click(stopSlideShow);var $navRight=$('.nav.right',$m_viewer).click(next).click(stopSlideShow);if(nMax<2){$navLeft.hide();$navRight.hide()}var strOrigLeft=$navLeft.css('left');var strOrigRight=$navRight.css('right');var showNav=function(){$navLeft.animate({left:0},100);$navRight.animate({right:0},100)};var hideNav=function(){$navLeft.animate({left:strOrigLeft},100);$navRight.animate({right:strOrigRight},100)};$m_viewer.hover(function(ev){if(!m_bThumbsOpen)showNav()},function(ev){if(!m_bThumbsOpen)hideNav()});return{show:showNav,hide:hideNav}}();(function(){var $thumbContainer=$('.thumbs',$m_viewer).css({top:m_nHeight,height:m_nHeight});var bThumbsPopulated=false;var $openThumbs=$('.bar .th',$m_viewer);var closeThumbContainer=function(){if(m_bThumbsOpen){$thumbContainer.stop(true).animate({top:m_nHeight});m_bThumbsOpen=false;$openThumbs.removeClass('open').attr('title',ImageViewerML.th);oNav.show();$m_slide.css({visibility:"visible"});$m_caption.css({visibility:"visible"});$m_count.css({visibility:"visible"})}};var populateThumbContainer=function(){var $thumb;if(!bThumbsPopulated){bThumbsPopulated=true;for(var index=0;index<nMax;index++){$thumb=$m_imgFirst.clone().attr({src:strMediaURL+oImageInfo.t.u+index}).data('index',index);$thumb.removeAttr('style');$thumbContainer.append($thumb)}$thumbContainer.find('img').wrap('<li></li>');$thumbContainer.wrapInner('<ul></ul>');$thumbContainer.delegate('img','click',function(ev){closeThumbContainer();jump($(this).data('index'))})}};var openThumbContainer=function(){if(!m_bThumbsOpen){$thumbContainer.stop(true).animate({top:15});$thumbContainer.css({height:m_nHeight-15});m_bThumbsOpen=true;$openThumbs.addClass('open').attr('title',ImageViewerML.closeth);populateThumbContainer();oNav.hide();$m_slide.css({visibility:"hidden"});$m_caption.css({visibility:"hidden"});$m_count.css({visibility:"hidden"})}};$openThumbs.click(function(ev){if(m_bThumbsOpen)closeThumbContainer();else openThumbContainer()})})();if(nInitial)jump(nInitial);var PADDING=200;var adjustedImageDimensions=function(){if(DEBUG)console.log('adjustimagedimensions call');var naturalHeight=parseInt($m_images.find('img',m_nCurrent).attr('data-height-original'));var naturalWidth=parseInt($m_images.find('img',m_nCurrent).attr('data-width-original'));var viewWidth=viewPortWidth();var viewHeight=viewPortHeight();if(DEBUG)console.log('view:',viewWidth,viewHeight,'natural:',naturalWidth,naturalHeight);if(naturalWidth>viewWidth-PADDING/2||naturalHeight>viewHeight-PADDING/2){var ratio=Math.min(viewWidth/naturalWidth,viewHeight/naturalHeight);return{width:Math.ceil(ratio*naturalWidth-PADDING/2),height:Math.ceil(ratio*naturalHeight-PADDING/2)}}return{width:naturalWidth,height:naturalHeight}};var stageXPoint=function(){return viewPortWidth()/2};var stageYPoint=function(){return viewPortHeight()/2};var centerStage=function(){var h=$('.lightbox').height()/2;var w=$('.lightbox').width()/2;var aid=adjustedImageDimensions();$(".lightbox").css({position:"absolute",left:stageXPoint()-w+$(window).scrollLeft()-10,top:stageYPoint()-h+$(window).scrollTop()-10,width:aid.width,height:parseInt(aid.height)+(nMax<1?0:33)});$('.lightbox .iv').css({position:"absolute",width:aid.width,height:parseInt(aid.height)+(nMax<1?0:33)})};var resizeStage=function(){var aid=adjustedImageDimensions();m_nWidth=aid.width;m_nHeight=aid.height;var h=parseInt(aid.height)+(nMax<1?0:33);$('.lightbox').css({width:aid.width,height:h});$('.lightbox .iv').css({width:aid.width,height:h});$m_images.find('img').css({width:parseInt(aid.width),height:parseInt(aid.height)});$m_images.css({left:m_nWidth*m_nCurrent*-1});var _h=$('.images').css('height');$('.lightbox .thumbs').css({height:h-33});$('.lightbox .bar').css({top:parseInt(aid.height)})};return{centerStage:centerStage,resizeStage:resizeStage}};ImageViewerClass.isTouch=function(){return'ontouchstart'in document.documentElement||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0}();ImageViewerClass.captionInit=function(strCaptionsURL,oStdParams){if(strCaptionsURL){var aKeys=[];var dIVs={};$('div.iv').each(function(){var $this=$(this);var key=$this.data('key');if(key){if($.inArray(key,aKeys)<0)aKeys.push(key);dIVs[key]=!dIVs[key]?$this:dIVs[key].add($this)}});$.getJSON(strCaptionsURL,$.extend(oStdParams,{key:aKeys.join(',')}),function(data,strStatus,xhr){if(data.captions)for(var strKey in data.captions)if(dIVs[strKey]){dIVs[strKey].data('captions',data.captions[strKey]);dIVs[strKey].trigger('captionsloaded')}})}};if($.mobile&&!$(document).data('iv-init-bound'))$(document).data('iv-init-bound',true).on('mtx-imageviewer-init','div.iv[data-count]',function(ev){var $iv=$(this);if(!$iv.data('iv-js-bound')){$iv.data('iv-js-bound',true);var strGallery=$iv.data('gallery');var sizeOpts=$iv.data('sizeopts');if(strGallery)sizeOpts.openLB=function(){$("body").pagecontainer("change",strGallery)};ImageViewerClass($iv,$iv.data('count'),$iv.data('mediabase'),[],null,sizeOpts)}}).filter(function(){return $(this).data('count')>1}).trigger('mtx-imageviewer-init');var ImageViewerLightboxClose=null;var ImageViewerLightbox=function(nMax,strMediaURL,straCaptions,oStdParams,oImageInfo,nInitial){var viewPortWidth=function(){return Math.max(document.documentElement.clientWidth,window.innerWidth||0)};var viewPortHeight=function(){return Math.max(document.documentElement.clientHeight,window.innerHeight||0)};var size={w:oImageInfo.l.w,h:oImageInfo.l.h,u:oImageInfo.l.u};var ratio=Math.max(size.w/viewPortWidth(),(size.h+(nMax<1?0:33))/viewPortHeight());if(ratio>1)size={w:Math.floor(size.w/ratio),h:Math.floor(size.h/ratio),u:oImageInfo.l.u};var lightboxTemplate=function(){return''+'<div class="iv" data-key="'+oStdParams.key+'" style=" width:'+size.w+'px; height:'+size.h+'px; position: absolute; z-index: 8192">'+'<div class="stage">'+'<div class="images"><img style="position: relative; vertical-align: top; width:'+size.w+'px; height:'+size.h+'px;" src="'+strMediaURL+size.u+'0" alt="" data-width-original='+oImageInfo.l.w+' data-height-original='+oImageInfo.l.h+' /></div>'+'<button class="nav right" style="z-index: 8222"></button>'+'<button class="nav left"  style="z-index: 8222"></button>'+'</div>'+'<div class="thumbs" style="position: absolute; z-index: 8232; top: '+size.h+'px"></div>'+(nMax<1?'':'<div class="bar" style="position: absolute; top: '+size.h+'px; z-index: 8242"><div class="count" style="position: absolute; z-index: 8282"></div><div class="caption" style="position: absolute; z-index: 8282"></div>'+(nMax<2?'':'<span style="position: absolute; z-index: 8252" class="th icon" title="'+ImageViewerML.th+'"></span><span style="position: absolute; z-index: 8262" class="slideshow icon" title="'+ImageViewerML.play+'"></span>')+'<span style="position: absolute; z-index: 8272" class="print icon" title="'+ImageViewerML.print+'"></span></div>')+'</div>'};var $m_shield;var $m_lightbox;var $m_doc=$('body');if(ImageViewerClass.stopSlideShow)ImageViewerClass.stopSlideShow();var scrollPhoto=function(event){if($(event.target).is('input, select, textarea')||event.type!='keyup')return;if(event.which==37){$('.lightbox .nav.left').click();event.preventDefault();event.stopPropagation()}if(event.which==39){$('.lightbox .nav.right').click();event.preventDefault();event.stopPropagation()}};$m_doc.bind('keyup',scrollPhoto);var closeLightbox=function(ev){$m_doc.unbind('keyup',scrollPhoto);$m_shield.remove();$m_lightbox.remove();void(ev&&ev.stopPropagation());if(closeLightbox==ImageViewerLightboxClose)ImageViewerLightboxClose=null;return true};ImageViewerLightboxClose=closeLightbox;$m_shield=$('<div class="lightboxShield"></div>').click(closeLightbox);$m_lightbox=$('<div class="lightbox" style="padding-top: 30px; padding: 10px; position: absolute; top: 0; left: 0; width: '+size.w+'px; height: '+size.h+'px;"></div>').click(function(ev){ev.stopPropagation()});var $closeButton=$('<div class="close icon icon_close" style="z-index: 8222;"></div>').click(closeLightbox);$m_lightbox.append(lightboxTemplate());if(!ImageViewerClass.isTouch)$m_lightbox.hover(function(ev){$closeButton.fadeIn(100)},function(ev){$closeButton.fadeOut(100)});$m_doc.append($m_shield);$m_doc.append($m_lightbox);$m_lightbox.append($closeButton);if(typeof straCaptions=="string"){ImageViewerClass.captionInit(straCaptions,oStdParams);straCaptions=[]}var v=ImageViewerClass($m_lightbox.find('.iv'),nMax,strMediaURL,straCaptions,oStdParams,{t:oImageInfo.t,m:size},nInitial);v.resizeStage();v.centerStage();var waitForFinalEvent=function(){var timers={};return function(callback,ms,uniqueId){if(!uniqueId)uniqueId="Don't call this twice without a uniqueId";if(timers[uniqueId])clearTimeout(timers[uniqueId]);timers[uniqueId]=setTimeout(callback,ms)}}();$(window).bind('resize',function(){waitForFinalEvent(function(){v.resizeStage();v.centerStage()},500,"resize-ewoqij")});$(window).bind('scroll',function(){waitForFinalEvent(function(){v.centerStage()},500,"scroll-oiweejf")})};